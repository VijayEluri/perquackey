#!/usr/bin/env ruby
require 'optparse'
require 'ostruct'

conf = OpenStruct.new(:mode => :console, :port => 3000)

opts = OptionParser.new do |opts|
  opts.banner = "Usage: #{File.basename($0)} [options]"
  opts.separator ''
  opts.on('-s', '--server', 'Run as a web server') { conf.mode = :server }
  opts.on('-p', '--port PORT', "Port for web server (defaults to #{conf.port})") { |port| conf.port = port }
  opts.on('-h', '--help', 'Show this message') { puts opts; exit }
  opts.separator ''
end

opts.parse! ARGV

LIB_DIR = File.expand_path(File.join(File.dirname(__FILE__), '..', 'lib'))
$:.unshift LIB_DIR

case conf.mode
when :console
  require 'perquackey/console'
when :server
  require 'webrick'
  require 'rubygems'
  require 'camping/webrick'
  require 'perquackey/server'
  server = WEBrick::HTTPServer.new(:Port => conf.port)
  server.mount '/', WEBrick::CampingHandler, Perquackey
  trap(:INT) { server.shutdown }
  server.start
end
